<!DOCTYPE html>
<html>
<head>
    <title>Dot Pattern Similarity Task</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-canvas-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    
    
    <style>
        .jspsych-btn { margin: 5px; }
        .jspsych-content-wrapper {
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .jspsych-canvas-keyboard-response-stimulus {
            margin-bottom: 5px;
            position: relative; /* Ensure that the trial counter is positioned relative to this container */

        }
        .jspsych-canvas-keyboard-response-stimulus{
            margin-bottom: 1px;
            position: relative; 
        }
        .jspsych-html-slider-response-wrapper {
            margin-top: 0px;
        }
        .jspsych-content {
            padding: 10px;
        }
        
        .trial-counter {
            position: absolute; /* Changed from fixed to absolute */
            bottom: 10px;
            left: 10px;
            background-color: #f8f8f8;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10; /* Lower than the prompt to ensure it stays in the background */
        }
        
        .jspsych-content-wrapper {
            position: relative; /* Ensure that the trial counter is positioned relative to this container */
            padding-bottom: 60px; /* Add space for the trial counter */
        }
        
        .jspsych-display-element {
            max-width: 100%;
            height: auto;
            position: relative; /* Ensure that the prompt is positioned relative to this element */
            z-index: 20; /* Ensure the prompt appears above the trial counter */
        }
    </style>
    
</head>
<body></body>

<script>
    
    const CANVAS_WIDTH = window.innerWidth * 0.8; // 80% of viewport width
    const CANVAS_HEIGHT = window.innerHeight * 0.7; // 60% of viewport height
    
    
    
    
    document.addEventListener('DOMContentLoaded', function() {
        let mainTrialsStarted = false
        const numPreliminaryTrials = 2; 
        
        // Create or update the prompt container
        function updatePromptContainer(promptText) {
            let promptContainer = document.querySelector('.prompt-container');
            if (!promptContainer) {
                promptContainer = document.createElement('div');
                promptContainer.className = 'prompt-container';
                document.body.appendChild(promptContainer);
            }
            promptContainer.innerHTML = promptText;
        }
        
        function updateCanvasSize() {
            const maxWidth = window.innerWidth * 0.8; // Use 80% of window width
            const maxHeight = window.innerHeight * 0.6; // Use 60% of window height
            return {
                width: Math.min(650, maxWidth), // Ensure canvas is not wider than 650px or window width
                height: Math.min(350, maxHeight) // Ensure canvas is not taller than 350px or window height
            };
        }
        const canvasSize = updateCanvasSize(); // Initial canvas size
        window.addEventListener('resize', function() {
            // Optional: Adjust the canvas size on window resize for a fully responsive design
            const newCanvasSize = updateCanvasSize();
            // You may need to redraw or adjust the layout here if you want to handle live resizing
        });
        
        
        
        const jsPsych = initJsPsych({
            on_trial_start: function() {
                if (mainTrialsStarted) { 
                    let counterDiv = document.querySelector('.trial-counter');
                if (!counterDiv) {
                    counterDiv = document.createElement('div');
                    counterDiv.className = 'trial-counter';
                    // Append the trial counter to the jspsych-content-wrapper element
                    document.querySelector('.jspsych-content-wrapper').appendChild(counterDiv);
                }
                    const currentTrialIndex = jsPsych.getProgress().current_trial_global + 1; 
                    const totalMainTrials = jsPsych.getProgress().total_trials - numPreliminaryTrials;
                    // Only update the counter for main trials
                    if(currentTrialIndex > numPreliminaryTrials) {
                        const currentMainTrial = currentTrialIndex - numPreliminaryTrials;
                        counterDiv.textContent = `Trial ${currentMainTrial} / ${totalMainTrials}`;
                    }
                }
            },
            on_trial_finish: function() {
                var trial_data = jsPsych.data.get().last(1);
                console.log(trial_data.csv());
            },
            on_finish: function() {
                jsPsych.data.get().localSave('csv', 'similarity_ratings.csv');
            }
        });
        
        
        function drawPattern(context, pattern, xOffset, canvasWidth, canvasHeight) {
            const dotSize = .85; // Size of the dots
            const patternScale = 2.5; // Increased scale for larger patterns
            
            // Adjust the scale and centering based on the new requirements
            const scale = Math.min(canvasWidth , canvasHeight) / 45; // Adjust scale for larger patterns
            const centerX = xOffset + (canvasWidth / 2) +1 // Shift patterns to the right for centering
            const centerY = canvasHeight / 2;
            
            pattern.forEach(dot => {
                context.beginPath();
                
                const x = (dot.x * scale) + centerX - (canvasWidth * 0.25);
                const y = centerY - (dot.y * scale);
                context.arc(x, y, dotSize * patternScale, 0, 2 * Math.PI);
                context.fill();
            });
        }
        
        // Welcome page
        var welcome = {
            type: jsPsychInstructions,
            pages: [
            'Welcome to the Dot Pattern Similarity Task. <br><br> Press "Next" to continue.'
            ],
            show_clickable_nav: true
        };
        
        // Instructions page
        var instructions = {
            type: jsPsychInstructions,
            pages: [
            'In this task, you will be presented with pairs of dot patterns. <br><br>' +
            'Your job is to rate the similarity of each pair using the number keys on your keyboard. ' + 
            'Please press a key between 1 and 9 to indicate your rating, where 1 means "Not Similar" at all, ' +
            'and 9 means "Very Similar". You can use any number between 1 and 9 to provide a rating that best ' +
            'represents your perception of the similarity between the two patterns.<br><br>',
            'Examples of Dot Patterns that are highly similar: ' +
            '<br>' + 
            '<img src="assets/high_sim.png" style="max-width:40%; height:auto;"></img>', 
            'Examples of Dot Patterns that are not similar: ' +
            '<br>' + 
            '<img src="assets/low_sim.png" style="max-width:40%; height:auto;"></img>'
            ], 
            show_clickable_nav: true
        };
        
        
        function loadAndStartExperiment(callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'mc_patterns.json', true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var json = JSON.parse(xhr.responseText);
                    var trials = createTrialsFromJson(json);
                    if(callback) callback(trials); // Ensure callback is called with the trials
                } else {
                    console.error('There was a problem with the request.');
                }
            };
            xhr.send();
        }
        
        function createTrialsFromJson(json) {
            
            const trials = [];
            const keys = ['1','2','3','4','5','6','7','8','9']; // Allowed keys for response
            
            for (let i = 0; i < json.length; i += 3) {
                const patternSets = [
                [json[i], json[i + 1]],
                [json[i], json[i + 2]],
                [json[i + 1], json[i + 2]]
                ];
                
                patternSets.forEach(patternSet => {
                    const patterns = patternSet.map(trialData => {
                        return Array.from({length: 9}, (_, idx) => ({
                            x: trialData[`x${idx + 1}`],
                            y: trialData[`y${idx + 1}`]
                        }));
                    });
                    
                    trials.push({
                        type: jsPsychCanvasKeyboardResponse, // Use the Canvas Keyboard Response plugin
                        stimulus: function(c) {
                            let ctx = c.getContext('2d');
                            ctx.clearRect(0, 0, c.width, c.height);
                            const spacing = 60; // Space between patterns
                            const margin = 15; 
                            const patternWidth = (c.width - spacing - 2 * margin) / 2;
                            patterns.forEach((pattern, index) => {
                                const xOffset = margin + index * (patternWidth + spacing);
                                drawPattern(ctx, pattern, xOffset, c.width / patterns.length, c.height);
                            });
                        },
                        canvas_size: [CANVAS_WIDTH, CANVAS_HEIGHT],
                        choices: keys,
                        prompt: '<p>Rate the similarity of the patterns from 1-9 <br> (1=Not Similar, 9=Very Similar).</p>',
                        response_ends_trial: true,
                        data: {
                            pattern_1: JSON.stringify(patterns[0]),
                            pattern_2: JSON.stringify(patterns[1])
                        }
                    });
                });
            }
            return trials;
        }
        
        loadAndStartExperiment(function(trials) {
            mainTrialsStarted = true;
            
            var fullTimeline = [welcome, instructions].concat(trials);
            jsPsych.run(fullTimeline);
        });
        
    });
</script>
</html>
