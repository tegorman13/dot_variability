<!DOCTYPE html>
<html>
<head>
    <title>Dot Pattern Similarity Task</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-canvas-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>
<body></body>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const jsPsych = initJsPsych({
        on_trial_finish: function() {
            // Insert the logging code here
            // var all_data = jsPsych.data.get();
            // console.log(all_data.csv());
            var trial_data = jsPsych.data.get().last(1);
            console.log(trial_data.csv());
        },
        on_finish: function() {
            jsPsych.data.get().localSave('csv', 'similarity_ratings.csv');
        }
    });

    function drawPattern(context, pattern, xOffset) {
        // Assume the grid is 50x50 units with origin (0,0) at center
        const gridUnit = 50;
        const scale = context.canvas.width / (gridUnit * 5); // Scale based on canvas size and 3 patterns
        const centerX = context.canvas.width / 6; // Center for a single pattern part of the canvas
        const centerY = context.canvas.height / 2;

        pattern.forEach(dot => {
            context.beginPath();
            // Scale and translate the dot coordinates
            const x = (dot.x + gridUnit / 2) * scale + xOffset + centerX - scale * gridUnit / 2;
            const y = (dot.y + gridUnit / 2) * scale + centerY - scale * gridUnit / 2;
            context.arc(x, y, scale * 1.5, 0, 2 * Math.PI); // Scale the dot size as well
            context.fill();
        });
    }

    function loadAndStartExperiment() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    var json = JSON.parse(xhr.responseText);

                    // Convert the loaded JSON data into the format needed for the trials
                    const trials = [];
                    for (let i = 0; i < json.length; i += 3) {
                        const patterns = [json[i], json[i + 1], json[i + 2]].map(trialData => {
                            return Array.from({length: 9}, (_, idx) => ({
                                x: trialData[`x${idx + 1}`],
                                y: trialData[`y${idx + 1}`]
                            }));
                        });

                        // Define the trial using the patterns
                        trials.push({
                            type: jsPsychHtmlSliderResponse,
                            stimulus: function() {
                                var html = '<canvas id="dot-pattern-canvas" width="900" height="300"></canvas>';
                                return html;
                            },
                            labels: ['Not Similar', 'Very Similar'],
                            slider_start: 50,
                            on_load: function() {
                                const canvas = document.getElementById('dot-pattern-canvas');
                                const context = canvas.getContext('2d');
                                context.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas before drawing
                                const width = canvas.width / 3; // Width allocated for each pattern
                                patterns.forEach((pattern, index) => {
                                    drawPattern(context, pattern, index * width);
                                });
                            },
                            prompt: '<p>Rate the similarity of the patterns.</p>',
                            response_ends_trial: true,
                            data: {
                                pattern_1: JSON.stringify(patterns[0]),
                                pattern_2: JSON.stringify(patterns[1]),
                                pattern_3: JSON.stringify(patterns[2])
                            }
                        });
                    }

                    // Run the jsPsych experiment with the trials
                    jsPsych.run(trials);
                } else {
                    console.error('There was a problem with the request.');
                }
            }
        };
        xhr.open('GET', 'mc_patterns.json', true);
        xhr.send();
    }
    loadAndStartExperiment();
});
</script>
</html>